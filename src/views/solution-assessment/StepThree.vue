<template>
  <div class="step-three">
    <!-- 进度展示区域 -->
    <div class="progress-container">
      <span class="progress-title">{{ loadedCards >= totalCards ? '评估已完成' : '正在评估' }}</span>
      <div class="progress-bar">
        <div class="progress-track">
          <div class="progress-fill" :style="{ width: `${progress}%` }"></div>
          <span class="progress-percentage">{{ progress }}%</span>
        </div>
      </div>
      <span v-if="loadedCards < totalCards" class="remaining-time">预计剩余时长：{{ remainingTime }}</span>
    </div>
    
    <!-- 评估卡片区域 -->
    <div class="assessment-container">
      <div v-for="(item, index) in assessmentList" :key="index" class="assessment-section">
        <div class="assessment-header" @click="toggleSection(index)">
          <span class="assessment-title">{{ item.title }}</span>
          <div class="icon-wrapper">
            <img 
              src="@/assets/assess/down_color.png" 
              alt="toggle" 
              class="toggle-icon"
              :class="{ 'collapsed': !item.isExpanded }"
            />
          </div>
        </div>
        
        <div class="assessment-cards" v-show="item.isExpanded">
          <div v-for="(card, cardIndex) in item.cards" :key="cardIndex" class="assessment-card" :class="{ 'loading': card.loading, 'highlighted': card.highlighted }">
            <div class="card-header">
              <span v-if="!card.loading" class="user-name" :class="{ 'user2': card.loading }">{{ card.userName }}</span>
              <div class="score-info">
                <template v-if="!card.loading">
                  <span class="score-label">得分</span>
                  <div class="score-value" :style="{
                    color: scoreColors[card.score]?.color,
                    background: scoreColors[card.score]?.bgColor
                  }">{{ card.score }}</div>
                  <div class="score-level" :style="{
                    color: scoreColors[card.score]?.color,
                    background: scoreColors[card.score]?.bgColor
                  }">{{ card.scoreLevel }}</div>
                </template>
                <img v-else src="@/assets/assess/score.png" alt="score skeleton" style="width:58px;height:22px;object-fit:contain;" />
              </div>
            </div>
            
            <div class="card-content" :class="{ 'loading': card.loading }">
              <template v-if="!card.loading">
                <pre>{{ card.content }}</pre>
              </template>
              <img v-else src="@/assets/assess/infos.png" alt="infos skeleton" style="width:100%;max-width:520px;object-fit:contain;" />
            </div>
            
            <div class="card-tags" :class="{ 'loading': card.loading }">
              <template v-if="!card.loading">
                <div v-for="(tag, tagIndex) in card.tags" :key="tagIndex" class="tag">{{ tag }}</div>
              </template>
              <img v-else src="@/assets/assess/tags.png" alt="tags skeleton" style="height:36px;object-fit:contain;" />
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, defineEmits, watch, nextTick } from 'vue'

// 定义emit
const emit = defineEmits(['loading-status-change', 'assessment-completed', 'clear-scroll-position'])

// 接收从父组件传递的属性
const props = defineProps({
  functionName: {
    type: String,
    default: ''
  },
  functionDesc: {
    type: String,
    default: ''
  },
  selectedIndicators: {
    type: Array,
    default: () => []
  },
  roleList: {
    type: Array,
    default: () => []
  },
  // 添加新属性，用于判断是否已完成评估
  savedAssessmentData: {
    type: Object,
    default: null
  },
  // 接收滚动位置信息
  scrollToPosition: {
    type: Object,
    default: null
  },
  // 标记是从步骤4跳转过来的
  isFromStepFour: {
    type: Boolean,
    default: false
  }
})

// 可配置的进度和时间
const progress = ref(0)
const remainingTime = ref('')
const totalCards = ref(0) // 总卡片数量
const loadedCards = ref(0) // 已加载的卡片数量

// 评分颜色配置
const scoreColors = {
  1: { color: '#CB272D', bgColor: '#FFECE8' },
  2: { color: '#D25F00', bgColor: '#FFF7E8' },
  3: { color: '#F1CC36', bgColor: '#FEFCE8' },
  4: { color: '#0E42D2', bgColor: '#E8F3FF' },
  5: { color: '#009A29', bgColor: '#E8FFEA' }
}

// 评估内容表：按照指标和序号组织内容
const assessmentContentTable = {
  '易操作性/是否符合直觉与习惯用法': {
    1: {
      score: 3,
      content: `根据"符合直觉与习惯用法"这一二级指标下的三个核心维度评分：功能层级：3分
→ 结构基本合理，但入口冗余、分类模糊，对目标不清用户不够友好。

"脑洞特效"图标：3分
→ 风格吸引人，视觉有趣，但图标和名称语义不够直观，需试探点击理解。

下拉"最近使用"：4分
→ 交互方式贴近系统习惯，直觉性强，但缺乏引导提示，发现门槛略高。`
    },
    2: {
      score: 3,
      content: `+ 优点：
   整体UI遵循主流视频编辑类App的布局模式（大按钮 + 功能九宫格 + 底部导航），基础框架符合用户对该类工具的通用认知；
  最近使用栏设计贴合熟练用户使用场景，图标清晰，支持高效跳转；
  界面图标风格统一，视觉负担不重，初看不令人困惑。
 – 缺点：
   信息冗余与功能重复严重（如"画质修复"三处出现），破坏了用户对功能分区的预期一致性。
  部分图标语义缺乏直觉性（尤其是"脑洞特效"），容易令目标感不强的用户产生疑惑或忽略。
  下拉区域缺乏发现性提示，对于中低活跃用户是一个隐性功能，难以形成使用习惯。
该界面在"符合直觉与习惯用法"方面表现中规中矩，基础设计逻辑正确但细节处理有欠缺，尚未形成一种真正"无需解释也能理解"的使用体验。`
    },
    3: {
      score: 3,
      content: `·功能层级结构清晰但略显冗余（4分）
 主页面的层次基本符合用户习惯，操作路径直观，但"视频美容"类入口与九宫格中部分功能重复，导致用户在理解"应该点哪里"时存在犹豫，降低了操作直觉性。
·个别功能图标与命名不直观（2分）
 例如"脑洞特效"图标缺乏语义对应，名称抽象，违背了图标/文案应协同传达功能意义的直觉认知原则，这种不明确会增加认知负担。
 下拉"最近使用"交互方式符合趋势但缺乏显性引导（3分）
 操作逻辑合理，机制是用户熟悉的，但没有显著提示或引导，让该功能被"隐藏"，首次使用时用户难以发现，从而影响直觉符合度。
评分采取加权折中思维：层级清晰性表现优（4），但图标语义和交互发现性拖了后腿（2和3），最终拉低整体的直觉贴合感。虽然界面专业用户可较快适应，但对于目标模糊的用户（如娱乐向用户）仍存在明显认知门槛。`
    },
    4: {
      score: 4,
      content: `Wink首页整体上在界面结构与交互逻辑上较好地贴合了用户习惯，尤其在操作路径、最近使用调用等方面做得直观流畅。但个别功能图标和术语命名上存在偏差，未能充分利用用户直觉联想，降低了首次使用时的理解效率。因此总体为**"大体符合直觉，但仍有局部改进空间"**的水准。`
    },
    5: {
      score: 3,
      content: `1.功能层级结构（评分：3）
  ·主体分区大致合理，主功能突出；
  ·但存在功能重复（如"画质修复"出现在多个区域）和图标分组不清，略增加理解负担。
2. "脑洞特效"图标语义（评分：2）
  ·图标与功能语义匹配弱，难以直观理解；
  ·对初次使用者不友好，不利于快速识别。
3.下拉呼出"最近使用"栏（评分：4）
  ·符合智能手机中部分主流应用的操作模式；
  ·但缺少提示，导致易被忽视。虽然界面在部分设计上遵循了常见平台习惯，但存在信息重复、部分功能表达不清等问题，尤其是图标语义和信息组织对新手用户略显不友好。因此，该首页在"符合直觉与习惯用法"方面表现中等，给出合理且保守的评分为 3 分。`
    },
    6: {
      score: 3,
      content: `从"是否符合直觉与习惯用法"这一维度综合来看，该页面在部分方面表现中规中矩，但缺乏优异表现或关键直觉引导，具体体现为：
·有正面表现：
   下拉"最近使用"逻辑贴合系统操作习惯，便捷高效。
  整体功能都聚焦在视频相关，避免出现完全无关的操作路径，主题明确。
·存在明显短板：
   功能层级存在重复和主次不清的问题，使得新用户无法快速判断入口选择，容易走"回头路"或试错；
  "脑洞特效"命名与图标不符合行业共识或大众语义联想，对低熟用户不够友好；
  多处缺乏必要的引导元素（如动画、提示语、状态高亮），使得功能虽合理但使用门槛偏高。
因此，我认为"符合直觉与习惯用法"方面的表现处于中等水平，不算明显反直觉，也尚未达到理想直觉体验的标准，所以给出总评分 3分（中性偏下） 是合理、可信的判断。`
    },
    7: {
      score: 3,
      content: `部分设计贴近通用习惯（得分项）：
下拉呼出的「最近使用」栏贴合主流移动交互模式，符合现代App用户的操作直觉（得分较高）。
存在直觉性不足的问题（扣分项）：
功能层级虽然不混乱，但缺乏明显的逻辑组织，导致初次使用者对模块划分认知模糊；
「脑洞特效」图标在视觉符号和语义联想上较弱，难以通过图形推测功能，降低易理解性。
从用户认知出发，整体不够"即看即懂"：
对于我这样的目标用户（产品不熟，但目标明确），理想界面应尽量减少点击试探和理解成本；
当前首页在少数元素上需要"尝试后才懂"，这不符合"直觉用法"的基本原则。`
    },
    8: {
      score: 3,
      content: `表现中等偏上：界面在多数情况下遵循了常见的用户习惯，特别是主功能布局与下拉快捷区设计方向是合理的；
 
  存在明显破绽：但也暴露出一些较明显的直觉性短板：
   "脑洞特效"图标语义脱离，用户无法仅靠图形识别；
 
  多处功能冗余（如"AI扩展"重复出现），增加了理解负担；
 
  下拉栏虽设计合理，但入口提示不明显，违背了"可感知性"的直觉操作原则。
该首页在直觉性设计方面达到了基本可用标准，但尚未形成统一、清晰的图标语言与功能分层逻辑，对初次使用者并不完全友好，因此得出较为中性的评分 3分，具有一定优化空间。`
    }
  },
  '易学性/易于上手': {
    1: {
      score: 4,
      content: '系统提供了清晰的引导和提示，新用户能够快速理解功能并开始使用。操作步骤简单明了，不需要复杂的学习过程。'
    },
    2: {
      score: 3,
      content: '系统在某些功能上缺乏必要的说明，可能导致用户需要尝试多次才能理解正确的使用方法。'
    }
  },
  '易学性/文案信息的易理解性': {
    1: {
      score: 3,
      content: `整体信息清晰度存在分化：
"视频截图"表现极佳，语义清晰、符合直觉；
"魔法照片"虽具吸引力，但含义模糊，不利于功能识别；
"配方"最为抽象，缺乏上下文提示，对视频编辑领域用户存在明显理解障碍。
缺乏一致的命名规范：
三个功能的命名风格不统一，有的偏技术功能（如"视频截图"），有的偏情绪营销（如"魔法照片"），有的则过于抽象（如"配方"），降低了整体认知效率。
对目标感弱的用户不友好：
对我这一类"娱乐导向但目标感较低"的用户而言，缺乏清晰引导的命名会直接影响点击意愿与初次体验。`
    },
    2: {
      score: 3,
      content: `评分构成：三个功能评分为 2（配方）、4（视频截图）、3（魔法照片），平均值约为 3。
  具体分析维度：
   语言是否清晰具体：仅"视频截图"具备直接的语义清晰度；"魔法照片"与"配方"都存在较强语义模糊。
  术语是否符合用户预期和上下文：使用了部分"创意化"命名（如"魔法""配方"），对我这种目标不明确的用户来说，初始理解困难。
  是否具备辅助信息（如副标题、图标强化语义）：图标风格统一，但未能有效增强文案的解释性。
综合评价：
 虽然界面整体风格统一、视觉呈现友好，但在功能命名上过于偏创意表达，牺牲了一定的直观理解性，对"初次或非目标明确用户"不够友好，特别是"配方"这类用词脱离通用语境，降低了信息的可理解程度。`
    },
    3: {
      score: 3,
      content: `极强的两极分化：
   "视频截图"的文案精准、无歧义，完全符合该维度的理想表现；
 
  "配方"的命名则非常不直观，显著拉低整体可理解性；
 
  "魔法照片"虽然有吸引力，但功能不明确，略高于平均。
 
 
 
 对"目标感低"的用户不友好：
   本用户画像更依赖文案提示来探索功能。若名称模糊，极易导致放弃点击或试错成本上升；
 
  当前有1个完全明确（视频截图），1个部分明确（魔法照片），1个高度误导（配方），整体文案清晰度处于中等偏下水平。
 
 
 
 存在优化空间：
   若能统一命名风格，使文案更具功能指向性（而非感性词汇或隐喻表达），该页面可达4分以上。`
    },
    4: {
      score: 3,
      content: `综合来看，该页面在"文案信息的易理解性"上表现中等偏上：
  优点在于个别功能如"视频截图"用词直接、语义清晰。
 
  但存在重要功能名称模糊、无助解释或图文不匹配等问题，特别是"配方"和"魔法照片"对不具备强目标导向的用户来说理解负担较高。
 
  在目标用户为轻量社交娱乐用户的场景下，这种模糊表达会降低探索意愿和使用效率。
 
 
整体仍有提升空间，建议重点优化语义表达的一致性和自解释能力。
是否需要我继续评估其他维度，比如界面清晰性或操作效率？`
    },
    5: {
      score: 3,
      content: `该页面在"文案信息的易理解性"指标下表现中等偏上，原因如下：
表现优异（视频截图，得分5）：文案表达准确，图标语义清晰，用户无需学习即可理解其功能，体现出良好的"自解释性"。
 
  表现一般（魔法照片，得分3）：虽然具有吸引力和品牌调性，但缺乏功能指向性，容易让新用户产生疑惑，需靠试探性点击了解具体用途。
 
  表现较差（配方，得分2）：命名抽象，与视频编辑语境脱节，缺少直观关联性，对产品不了解的用户几乎无法猜测其功能。
 
 
 综合来看，虽然页面部分文案达到了"通俗易懂"的标准，但存在关键功能命名缺乏透明度、难以从字面理解的问题，尤其对初次用户造成较高认知负担，因此总评分为 3分（中等）。`
    },
    6: {
      score: 3,
      content: `文案表现不一致：三项中，"视频截图"表现极佳，完全符合直觉；"魔法照片"具吸引力但略显模糊；"配方"则严重不清晰，拖累整体认知体验。
  理解门槛存在差异：一个优秀的信息文案应当让用户无需探索就能理解功能预期，但"配方"完全不具此属性，"魔法照片"需要结合图标猜测含义，而仅"视频截图"达到理想标准。
  真实用户视角下的可用性偏弱：作为一位视频剪辑新手用户，我会对"配方"这种模糊标签产生犹豫，可能不敢直接点击，降低探索效率。
因此，综合三项指标中的最高（5）、中等（4）和偏低（2）表现，我给予本页面在**"文案信息的易理解性"指标下的总评分为 3 分（中等水平）**，反映出该页面有改进空间，尤其是对术语的通俗表达和语义清晰度的统一。`
    },
    7: {
      score: 3,
      content: `整体偏中等水平：界面中的文案多数短小简洁，但在**"含义透明度"和"结合使用场景解释功能"**方面存在显著差异。
  表现两极分化：
   「视频截图」这类文案直白易懂，图文匹配度高，表现良好；
  但像「配方」「魔法照片」这类命名带有营销意味或创意成分，对不熟悉产品的新用户缺乏清晰引导，理解成本较高。
  缺乏辅助解释机制：无二级文案或悬浮提示，依赖用户点击或尝试探索，不利于快速上手和目标达成。
建议提升方向：
  为「配方」「魔法照片」添加副标题或使用情境提示，如："一键套用视频特效模板"、"将照片变成动态效果"等；
 
  可设计长按浮动提示或首次使用引导，减少用户试错成本。`
    },
    8: {
      score: 3,
      content: `平均水平评估：三个功能评分分别为2、4、3，均值为3，反映出整体文案在"易理解性"方面处于中等水平；
  理解负担不均：个别文案（如"配方"）对新用户极不友好，几乎无法从字面理解含义，拉低整体评分；
  部分表达直观："视频截图"用语清晰，图标支持良好，但并未带动整体文案水平；
  缺乏一致性与说明性：整体文案风格不统一，有的偏口语吸引眼球，有的过于模糊，没有统一文案策略或分层引导，这对初次使用者尤其不友好。
 
如果Wink希望提升首页功能的易理解性，建议统一文案语义风格，并在模糊命名中加入简短解释或视觉提示，增强产品的"自解释性"。`
    }
  },
  '美观度/视觉和谐': {
    1: {
      score: 5,
      content: '界面视觉风格统一，配色舒适和谐，元素排布有序，整体美感出众。视觉层次分明，重点突出，次要信息适当弱化。'
    }
  },
  '清晰性/界面元素清晰度': {
    1: {
      score: 4,
      content: `👍 优秀表现（支持得分为4）：
  文字信息清晰、可读性强：
   全部采用高对比度字体，字号适中，常规术语无晦涩表达。
  图标与功能语义较为匹配：
   多数图标语义直观（如剪刀=剪辑、脸部=AI美容），且风格一致，增强整体识别力和专业感。
  视觉组织明确，界面整洁：
   首页主功能以大图标聚焦中心，九宫格功能排布对齐统一，易于定位和扫读。
  "最近使用"模块置顶分区，虽为下拉内容但层级结构合理。
 
👎 扣分点（导致不是5分）：
  部分图标语义仍不够自解释：
   如"脑洞特效""魔法照片""AI扩展"等，若无文字说明，图形本身难以准确传达功能用途，对目标不明确用户不够友好。
  下拉区的图标清晰度受背景影响：
   图标小、阴影弱，若背景视频动态性强或颜色复杂，图标可能不够突出，影响快速识别。`
    },
    2: {
      score: 4,
      content: `字体清晰易读（优）
   所有功能名称均使用清晰、大小适中的字体，黑底白字对比强烈，适合夜间/深色环境浏览；
  "Hot"标签视觉突出，利于识别热门功能。
  图标语义基本清晰（中等偏好）
   多数图标能通过图形辅助理解，如剪刀表示剪辑、人脸表示美颜； 
  但部分图标（如"转Live格式""AI扩展""脑洞特效"）图形与功能名称的直觉联想度偏低，对非专业用户尤其不友好，需依赖文字理解。 
  区域分隔合理但弹出部分风格弱（中等偏好）
   主界面结构分明，九宫格+大图标布局视觉整洁； 
  顶部"下拉唤出"区域边界不够突出，风格不一致，存在视觉割裂感，影响整体辨识。 
因此，我作为该目标用户类型，给出界面元素清晰度维度的最终评分为：
👉 4 分（满分 5 分） — 清晰度总体较好，但图标直观性和区域风格一致性尚有优化空间。`
    },
    3: {
      score: 4,
      content: `✅ 主要优点：
  字体清晰、对比度高，阅读无压力； 
  大多数图标语义明确，与功能高度契合；
  区域划分清晰、排布合理，整体浏览体验舒适；
  统一的风格与图标系统，提升识别效率。 
⚠️ 存在的问题：
  部分图标抽象，对低目标感用户理解有门槛； 
  图标优先级层级感不足，视觉上看不出哪个更重要； 
  缺少点击反馈与边框提示，可能会让用户对"是否可操作"产生疑问。
  
因此，虽然整体表现良好、易于操作，但由于部分视觉引导与图标语义仍有提升空间，我将该界面的"界面元素清晰度"评分评定为4分。这表示整体认同其清晰度，但未达到完全优秀的程度。`
    },
    4: {
      score: 4,
      content: `作为一位具备较强领域认知但目标不明确的用户，我认为 Wink 首页在功能入口的界面元素清晰度方面表现"较好"，理由如下：
✅ 优势明确：
  图文结合直观明了：绝大多数功能图标语义清晰，配合文字标签极大减少理解负担；
 
  布局整齐：九宫格结构、下拉区与底栏分层明确，符合用户扫读习惯； 
  标签语言简洁：功能命名非术语化，适合泛用户理解；
  热门功能有"Hot"标签突出，有助于引导使用。 
⚠️ 但仍存在可感知的问题：
  部分图标语义抽象，如"转Live格式"与"魔法照片"，对于低目标用户不够友好；
  视觉主次不分：所有图标大小风格几乎一致，缺乏视觉引导重点；
  风格略显杂糅：部分AI相关图标卡通化明显，整体缺乏设计一致性。
  
这些不足尚未严重影响使用，但会在用户无明确任务动机时，略微增加理解与探索的心理负担。`
    },
    5: {
      score: 4,
      content: `该界面的功能入口在大部分元素清晰度方面表现良好，达到较高水准，但尚未做到完全无障碍或毫无疑问，具体表现如下：
✅ 优势：
  字体清晰、对比强烈，在深色背景下非常易读；
  图标整体语义明确，与功能名搭配合理； 
  布局层级清楚，不同模块间通过卡片、分区形成良好分隔感，避免了视觉混乱。 
⚠️ 待提升点：
  个别图标（如"脑洞特效"）象征意义略显模糊；
  "最近使用"区块视觉突出程度略弱，与下方功能区辨识度不够强，不利于快速注意到其快捷价值； 
  没有辅助性提示信息（例如小标签、说明）来强化新手用户对不常见功能的初步理解。
  
综上，我认为"界面元素清晰度"在当前界面中已经达到非常清楚但还存在少量模糊点的水平，因此评分为 4 分（满分 5 分） 是合理且准确的。`
    },
    6: {
      score: 4,
      content: `优势（支持得分较高的原因）：
  图标与文字结合明确，传达清晰：
 所有功能入口都配有图标和文字，视觉直观，基本可以"看图识功能"，对18-24岁用户特别友好。
 
  视觉层级清晰，重要功能突出：
 如"视频美容"按钮体积最大、居中，形成视觉焦点；顶部"最近使用"区域通过背景和位置强调快捷性。
  对比度与可读性好：
 黑色背景搭配白色图标和字体，清晰度高，即使在不同光照下使用，也不易看不清。 
扣分原因（为何未给5分）：
  部分图标过于相似，语义区分不够明显：
 "转Live格式"和"修Live"图标在形状与构图上几乎一致，容易混淆，尤其对新用户来说辨识度下降。
  布局密集感略强：
 尤其是底部功能区图标密度较高，图标与文字、图标之间间隔偏紧，导致视觉呼吸感不足，有压迫感。
结论：
这个界面的功能入口清晰度整体表现是优秀的，具备明确的引导性和良好的识别性，对目标用户群体是友好的。但因为存在少数图标区分度不足和排布紧凑的问题，略影响初次识别体验，因此给出4分的合理评价，而非满分。`
    },
    7: {
      score: 4,
      content: `该界面在"界面元素清晰度"方面表现整体良好，得分4分，理由如下：
✅ 正面表现：
  字体清晰：字号适中，对比度高，阅读没有压力，尤其对18-24岁用户非常友好；
 
  图标风格统一：黑白线条图标风格一致，整体观感专业、整洁；
 
  功能分区明确：主功能按钮（剪辑、美容、修Live）体积大、位置居中，具引导性；
 
  最近使用区域封装良好：采用灰底卡片式设计，结构明确，易于识别与点击； 
  底部导航清晰易辨：当前页面高亮明显，分区准确。 
❌ 主要扣分点：
  部分图标语义不够直观：
   "脑洞特效"图标使用🎉表情符号，新用户难以根据图形推断其具体作用； 
  "转Live格式"与"修Live"图标相似，可能导致混淆。 
  少数图标需过度依赖文字解释，违背了图形传意应具备的"直觉性"。  
 
📝 总结陈述：
作为一名对该产品不熟、但目标明确的年轻用户，我能较快识别主入口与基本功能，也基本能理解各功能卡片。但在少数图标的语义传达上存在模糊，限制了初次使用时的效率与信心。整体表现优于平均水平，但仍有提升空间。`
    },
    8: {
      score: 4,
      content: `✅ 表现优秀之处：
  图标与文字结合明确，有助于快速识别功能：
   每个入口均配有图标+文本，且图标设计整体契合功能语义，降低理解门槛。 
  风格一致、排布整齐，视觉上干净利落：
   图标大小、颜色、留白、线性样式保持统一，避免视觉杂乱。
  通过"Hot"等标识强化了部分入口的视觉识别度：
   热门功能标记使用户快速识别重点内容，增强功能发现。
⚠️ 扣分原因：
  少数图标语义不够直观：
   如"AI扩展"、"脑洞特效"的图形表现不够自解释，需依赖文字。 
  顶部"最近使用"模块边界弱化：
   虽位于显著位置，但其背景模糊+阴影浅，视觉层级不够明显，尤其在动态图背景下不够突出。
  部分颜色/对比度在不同光线下可读性可能受限。
 
✅ 结论：
本界面在"界面元素清晰度"上总体表现良好，绝大多数功能入口清晰、易识别，设计一致性强。仅存在少量细节可优化之处，因此给予 4分 是合理且保守的评价。`
    }
  },
  '清晰性/界面布局合理性': {
    1: {
      score: 4,
      content: `首页中功能分区相对清晰，"视频剪辑 / 视频美容 / 修Live"三大入口居中，形成视觉焦点，符合操作频率排序。 
 下方九宫格模块采用图标+文字组合，分类较合理，操作直观。
 顶部"下拉唤出"区域虽然对高频用户友好，但首次不易发现，属于隐性入口，稍影响流畅感。
 整体排版有逻辑，但略显信息密集，有些图标样式重复，例如"画质修复""AI扩展"在多个位置重复出现，造成轻微的视觉负担。`
    },
    2: {
      score: 3,
      content: `界面缺乏视觉引导，例如图标间没有明显的层级感或颜色差异，导致"视频美容"和"视频剪辑"等入口虽然大，但未必足够突出。
 页面偏暗背景与统一的白色图标导致区分度不足，易使用户视觉游移。
 底部导航清晰，但"首页"与实际功能重合度高，"配方"与"我"的含义不直观（特别是"配方"对新手不友好）。 
 整体结构中规中矩，但缺少"引导感"和聚焦核心任务的"视觉动线"。`
    },
    3: {
      score: 5,
      content: `所有功能集中在首页一屏内，点击路径短，不需要额外跳转，极大提高效率。 
 功能入口的分区清晰可辨，尤其"下拉唤出最近使用"功能区，极大贴合重度使用者的需求，显著减少重复操作的时间。 
 图标均统一风格，操作手感一致，细节处理良好。
 虽然略显紧凑，但在功能覆盖和操作效率之间取得了较好平衡。`
    },
    4: {
      score: 4,
      content: `界面风格现代，图标卡通感与社交娱乐氛围契合。 
 中心位置的笑脸"视频美容"图标放大，具有识别度和趣味性，符合年轻女性对美颜类功能的使用偏好。 
 功能分布虽然紧凑，但视觉上呈现对称与居中，有美感。
 唯一减分点在于部分"热门"标签显得突兀，与整体设计协调度略低。`
    },
    5: {
      score: 4,
      content: `界面整体布局清晰，主操作区三大类操作按钮居中排列，有明确视觉重心，符合习惯操作流。但底部功能区域图标密集，图标风格相近，首次使用者可能不易一眼识别功能分组逻辑。顶部下拉区域设计为"最近使用"也较贴心，但没有明显指引，可能被忽略。`
    },
    6: {
        score: 3,
      content: `界面功能布局较多集中于中下部，虽然分类逻辑存在，但缺乏明显的分区标题或视觉隔断，容易让人产生堆叠感，特别是黑底图标区域显得拥挤。AI类功能重复出现在多个区域（如"AI扩展"出现在顶部与底部），也造成一定认知冗余。`
    },
    7: {
      score: 5,
      content: `视觉流动顺畅，从主操作按钮进入各细分类别操作逻辑自然。居中大图标"视频美容"有视觉吸引力，底部功能按钮图标简洁清晰，整体风格统一、易于上手。即使初次使用也能大致明白功能层次，符合"社交娱乐"用户的使用节奏。`
    },
    8: {
      score: 4,
      content: `主界面操作逻辑接近"点什么做什么"，按钮图标具一定引导性，符合"目标清晰"用户快速达成目的的需求。下拉显示最近使用很方便，但若无引导或提示动画，新用户容易忽略这个入口。底部功能块太多，不够突出"最常用"路径。`
    }
  },
  '清晰性/信息、功能入口容易找到': {
    1: {
      score: 5,
      content: `所需功能（如AI美容、AI扩展、AI消除）全部一屏可见，查找无障碍；
  多处出现"AI"标签，明确标识增强相关功能，有助快速定位；
  下拉"最近使用"对高频操作非常有帮助；
  热门标签（Hot）起到视觉引导作用；
  多种功能集中在首页，避免了多层级跳转，节省时间。`
    },
    2: {
      score: 4,
      content: `懂得下拉可唤出"最近使用"模块，提高效率； 
 入口整体层级较浅，大多数功能点两步内可达； 
 能较快识别图标代表的功能，虽然有些命名（如"AI扩展"）偏抽象，但不构成障碍； 
 "视频美容"作为视觉中心点，符合其使用频率高的场景； 
 仍存在小部分低频功能（如"脑洞特效"）入口不够明显。`
    },
    3: {
      score: 2,
      content: `虽然首页入口图标较为丰富，但对于一个目标感不强的轻度用户来说：
   大部分图标（如"AI扩展""转Live格式"）不具备直观性，图形+文案难以理解； 
  首页功能区域呈现方式较密集，图标数量多但主次不明，没有引导；
  下拉菜单这种交互模式对非重度用户不够明显，容易被忽略；
  用户更容易被中心大图标"视频美容"吸引，但不知道这是"AI美颜"等功能的上层入口。`
    },
    4: {
      score: 3,
      content: `能认出常见功能（如"去水印""视频剪辑"）； 
 "画质修复"有明显标签"Hot"，视觉上突出了热门功能；
 但功能图标彼此视觉权重类似，缺少主功能的突出感；
 功能分布在三个区域（主功能三图标、九宫格功能、下拉），结构有些分散，影响查找效率；
 图标样式统一虽美观，但不利于快速区分用途。`
    },
    5: {
        score: 4,
      content: `主功能按钮"视频美容"占据视觉中心，图标大且清晰，符合其目标任务，非常容易注意到； 
  图标样式直观，如"剪刀"代表剪辑、"笑脸"代表美容，语义基本贴合；
  下拉区"最近使用"设计合理，但初次使用者可能不会发现这是可以"下拉唤出"的，入口不够明显；
  "AI美容"与"视频美容"命名相近，可能造成轻微混淆。
 建议： 下拉提示可以更直观一些，例如用动画或小提示箭头强调交互方式。`
    },
    6: {
      score: 3,
      content: `"脑洞特效"被打了"Hot"标签，但图标样式并不突出，不容易第一眼识别其娱乐功能； 
  需要向下滚动才会看到更多娱乐类入口，这对目标明确的用户增加了路径长度； 
  "配方"页可能隐藏了一些模板或玩法，但首页未体现这一关系。 
 建议： 对高吸引力功能（如特效、魔法类）可以上移位置或加视觉强化（如色彩/动画），提升入口显著性。`
    },
    7: {
      score: 5,
      content: `"画质修复"、"去水印"、"视频截图"等与社交发布强相关的功能在首页均可直达； 
  "画质修复"同时出现在"最近使用"和主功能区，还标有"Hot"，非常突出；
  图标语义明确，入口层级浅，路径几乎为一跳，非常高效。
 整体体验非常契合其目标，入口明显、查找迅速，几乎无认知负担。`
    },
    8: {
      score: 4,
      content: `"视频剪辑"是首页主入口之一，图标易识别且显眼； 
  "转Live格式"既出现在主菜单也在"最近使用"区，重复呈现强化记忆；
  唯一的问题在于，"修Live"与"转Live格式"的命名关系不够清晰，可能误导。
 建议： 可以调整文案或加入描述，澄清"修Live"是否包含"转Live格式"。`
    }
  }
}

// 评估列表数据
const assessmentList = ref([])

// 记录是否已经执行过高亮动画
const hasHighlighted = ref(false)

// 初始化评估列表
onMounted(() => {
  // 重置高亮状态
  hasHighlighted.value = false
  
  // 如果已经有保存的评估数据，直接使用
  if (props.savedAssessmentData) {
    assessmentList.value = props.savedAssessmentData.assessmentList;
    loadedCards.value = props.savedAssessmentData.loadedCards;
    totalCards.value = props.savedAssessmentData.totalCards;
    progress.value = 100; // 直接显示100%
    return; // 不再执行后续初始化和加载逻辑
  }

  // 通知父组件禁用按钮
  emit('loading-status-change', true)
  
  // 根据selectedIndicators生成评估标题
  const assessmentItems = props.selectedIndicators.map(indicator => {
    // 处理指标标题，显示为"一级/二级"的格式
    let title = '';
    
    if (typeof indicator === 'object') {
      // 从指标中提取一级和二级指标
      if (indicator.value && typeof indicator.value === 'string') {
        // 处理类似StepTwo中的格式：从value中提取一级指标代码
        const firstLevelCode = indicator.value.split('_')[0];
        // 映射代码到实际一级指标文本
        const firstLevelText = getFirstLevelText(firstLevelCode);
        title = `${firstLevelText}/${indicator.label}`;
      }
      // 如果有parent属性和name属性
      else if (indicator.parent && indicator.name) {
        title = `${indicator.parent}/${indicator.name}`;
      } 
      // 如果有firstLevel和secondLevel属性
      else if (indicator.firstLevel && indicator.secondLevel) {
        title = `${indicator.firstLevel}/${indicator.secondLevel}`;
      }
      // 如果有primaryIndicator和name属性
      else if (indicator.primaryIndicator && indicator.name) {
        title = `${indicator.primaryIndicator}/${indicator.name}`;
      }
      // 如果只有name属性
      else if (indicator.name) {
        title = indicator.name;
      }
      // 如果只有label属性
      else if (indicator.label) {
        title = indicator.label;
      }
      // 其他情况
      else {
        title = '未命名';
      }
    } else {
      // 如果是字符串，直接使用
      title = indicator;
    }
    
    return {
      title: title,
      isExpanded: true,
      cards: []
    };
  })

  // 计算卡片总数并创建初始化的加载中卡片
  let allCards = [];
  let cardCount = 0;
  
  // 为每个评估项添加角色卡片
  assessmentItems.forEach(item => {
    let cardIndex = 1; // 角色卡片序号
    let itemCards = [];
    
    // 遍历角色列表
    props.roleList.forEach((role, index) => {
      // 根据role的count决定添加多少个卡片
      if (role.count > 0) {
        for (let i = 0; i < role.count; i++) {
          // 从内容表中获取对应的内容
          const contentData = assessmentContentTable[item.title]?.[cardIndex];
          
          // 如果在内容表中没有找到对应的内容，则使用默认值并添加提示
          const scoreValue = contentData ? contentData.score : 3;
          let contentValue = '';
          
          if (contentData) {
            contentValue = contentData.content;
          } else {
            contentValue = `[此指标${item.title}的第${cardIndex}号评估内容未配置]\n\n系统默认显示内容：该指标评估正在进行中，暂无评估结果。`;
            console.warn(`未找到指标"${item.title}"的第${cardIndex}号评估内容，将使用默认内容`);
          }
          
          // 生成角色标签
          const tags = [];
          if (role.tags && Array.isArray(role.tags)) {
            role.tags.forEach(tag => {
              if (tag.text) tags.push(tag.text);
            });
          } else {
            tags.push('男', '25-34', '学习办公', '领域专业度高', '产品了解度高', '目标清晰度高');
          }
          
          // 添加卡片（初始状态为加载中）
          const card = {
            userName: `${role.name || `用户${index + 1}`}`,
            score: scoreValue,
            scoreLevel: getScoreLevel(scoreValue),
            content: contentValue,
            tags: tags,
            loading: true, // 初始为加载中状态
            cardId: cardCount // 添加一个唯一标识
          };
          
          itemCards.push(card);
          allCards.push({ sectionIndex: assessmentItems.indexOf(item), cardIndex: itemCards.length - 1, card });
          cardCount++;
          cardIndex++; // 增加序号
        }
      }
    })
    
    // 如果没有添加任何卡片，则添加一个加载中的卡片
    if (itemCards.length === 0) {
      const card = {
        userName: '用户',
        loading: true,
        cardId: cardCount
      };
      itemCards.push(card);
      allCards.push({ sectionIndex: assessmentItems.indexOf(item), cardIndex: 0, card });
      cardCount++;
    }
    
    item.cards = itemCards;
  })

  assessmentList.value = assessmentItems;
  totalCards.value = cardCount;
  
  // 更新剩余时间
  updateRemainingTime();
  
  // 开始加载卡片
  startLoadingCards(allCards);
})

// 更新剩余时间
function updateRemainingTime() {
  const remaining = totalCards.value - loadedCards.value;
  const seconds = remaining;
  remainingTime.value = `${seconds}秒`;
}

// 开始加载卡片
function startLoadingCards(allCards) {
  // 移除随机打乱逻辑，改为按顺序加载
  const orderedCards = allCards;
  
  // 每0.3秒加载一个卡片
  const interval = setInterval(() => {
    if (loadedCards.value >= totalCards.value) {
      clearInterval(interval);
      remainingTime.value = '';
      // 通知父组件启用按钮
      emit('loading-status-change', false);
      
      // 通知父组件评估已完成，并传递评估结果
      emit('assessment-completed', {
        assessmentList: assessmentList.value,
        loadedCards: loadedCards.value,
        totalCards: totalCards.value
      });
      
      return;
    }
    
    const nextCard = orderedCards[loadedCards.value];
    if (nextCard) {
      // 更新卡片状态为已加载
      assessmentList.value[nextCard.sectionIndex].cards[nextCard.cardIndex].loading = false;
      loadedCards.value++;
      
      // 更新剩余时间
      updateRemainingTime();
      
      // 更新进度
      progress.value = Math.floor((loadedCards.value / totalCards.value) * 100);
    }
  }, 300);
}

// 获取评分等级
function getScoreLevel(score) {
  const levels = {
    1: '非常不满意',
    2: '不满意',
    3: '一般',
    4: '满意',
    5: '非常满意'
  }
  return levels[score] || '未知'
}

// 获取一级指标文本
function getFirstLevelText(code) {
  const indicatorMap = {
    'operability': '易操作性',
    'learnability': '易学性',
    'clarity': '清晰性',
    'aesthetics': '美观度',
    'accessibility': '无障碍性',
    'efficiency': '效率',
    'error': '容错性',
    'satisfaction': '满意度'
  };
  return indicatorMap[code] || code;
}

// 切换折叠状态
const toggleSection = (index) => {
  assessmentList.value[index].isExpanded = !assessmentList.value[index].isExpanded
}

// 监听滚动位置变化，只在从步骤4跳转且未执行过高亮时执行
watch(() => props.scrollToPosition, (newVal) => {
  if (newVal && props.isFromStepFour && !hasHighlighted.value) {
    nextTick(() => {
      scrollToCard(newVal.sectionIndex, newVal.cardIndex)
      // 设置已执行过高亮
      hasHighlighted.value = true
      // 通知父组件清除滚动位置
      emit('clear-scroll-position')
    })
  }
}, { immediate: true })

// 滚动到指定卡片
function scrollToCard(sectionIndex, cardIndex) {
  // 确保评估列表已加载
  if (!assessmentList.value || assessmentList.value.length === 0) return
  
  // 确保指定的section存在
  if (!assessmentList.value[sectionIndex]) return
  
  // 确保该section已展开
  if (!assessmentList.value[sectionIndex].isExpanded) {
    toggleSection(sectionIndex)
  }
  
  // 获取卡片DOM元素
  const cardSelector = `.assessment-section:nth-child(${sectionIndex + 1}) .assessment-card:nth-child(${cardIndex + 1})`
  nextTick(() => {
    const cardElement = document.querySelector(cardSelector)
    if (cardElement) {
      cardElement.scrollIntoView({ behavior: 'smooth', block: 'center' })
      
      // 添加高亮效果
      cardElement.classList.add('highlighted')
      
      // 3秒后移除高亮
      setTimeout(() => {
        cardElement.classList.remove('highlighted')
      }, 3000)
    }
  })
}
</script>

<style scoped lang="scss">
/* 进度展示模块 */
.progress-container {
  display: flex;
  align-items: center;
  width: 100%;
  gap: 16px;
  padding: 0 24px;
  padding-bottom: 28px;
  background-color: #F8FAFC;
  position: absolute;
  left: 0;
  right: 0;
  z-index: 100;
  
  .progress-title {
    font-family: 'PingFang SC';
    font-style: normal;
    font-weight: 400;
    font-size: 14px;
    line-height: 22px;
    color: #2B2B2B;
    white-space: nowrap;
    min-width: fit-content;
  }

  .progress-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
    min-width: 0;

    .progress-track {
      width: 100%;
      height: 16px;
      background: #E6E7FF;
      border-radius: 35px;
      overflow: hidden;
      position: relative;

      .progress-fill {
        height: 100%;
        background: #605CE5;
        border-radius: 35px;
        transition: width 0.3s ease;
      }

      .progress-percentage {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-family: 'PingFang SC';
        font-style: normal;
        font-weight: 400;
        font-size: 12px;
        line-height: 20px;
        color: #FFFFFF;
        white-space: nowrap;
        z-index: 1;
      }
    }
  }

  .remaining-time {
    font-family: 'PingFang SC';
    font-style: normal;
    font-weight: 400;
    font-size: 14px;
    line-height: 22px;
    color: #72728B;
    white-space: nowrap;
    min-width: fit-content;
  }
}

/* 评估卡片区域 */
.assessment-container {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 12px;
  width: 100%;
  padding-top: 50px;

  .assessment-section {
    width: 100%;
  }

  .assessment-header {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 9px;
    width: 100%;
    height: 22px;
    cursor: pointer;
    margin-bottom: 12px;

    .assessment-title {
      font-family: 'Nunito Sans';
      font-style: normal;
      font-weight: 600;
      font-size: 14px;
      line-height: 22px;
      color: #72728B;
    }

    .icon-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 20px;
      height: 20px;

      .toggle-icon {
        width: 20px;
        height: 20px;
        transition: transform 0.3s ease;

        &.collapsed {
          transform: rotate(180deg);
        }
      }
    }
  }

  .assessment-cards {
    display: flex;
    flex-direction: row;
    justify-content: flex-start;
    align-items: flex-start;
    gap: 16px;
    width: 100%;
    margin-bottom: 10px;
    flex-wrap: wrap;

    .assessment-card {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 14px 32px;
      gap: 7px;
      flex: 0 0 calc(50% - 16px);
      min-width: 300px;
      max-width: 584px;
      background: #FFFFFF;
      border: 1px solid #F2F3F5;
      border-radius: 6px;
      position: relative;
      overflow: hidden;
      margin-bottom: 16px;

      &.loading {
        .user-name {
          color: #F2F3F5;
        }

        .card-content {
          .loading-line {
            width: 100%;
            height: 20px;
            background: #D9D9D9;
            margin-bottom: 7px;
          }
        }

        .tag {
          background: #F2F3F5;
          color: #F2F3F5;
        }

        &::after {
          content: '';
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
          transform: translateX(-100%);
          background-image: linear-gradient(
            90deg,
            rgba(255, 255, 255, 0) 0,
            rgba(255, 255, 255, 0.2) 20%,
            rgba(255, 255, 255, 0.5) 60%,
            rgba(255, 255, 255, 0)
          );
          animation: shimmer 2s infinite;
        }
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;

        .user-name {
          font-family: 'Nunito Sans';
          font-style: normal;
          font-weight: 600;
          font-size: 16px;
          line-height: 24px;
          color: #605CE5;

          &.user2 {
            width: 42px;
            height: 24px;
            color: #F2F3F5;
            text-align: justify;
            flex: none;
            order: 0;
            flex-grow: 0;
          }
        }

        .score-info {
          display: flex;
          align-items: center;
          gap: 8px;

          .score-label {
            font-family: 'PingFang SC';
            font-style: normal;
            font-weight: 400;
            font-size: 14px;
            line-height: 22px;
            color: #000000;
          }

          .score-value {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-family: 'PingFang SC';
            font-style: normal;
            font-weight: 400;
            font-size: 14px;
            line-height: 22px;
          }

          .score-level {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 8px;
            border-radius: 100px;
            height: 22px;
            font-family: 'PingFang SC';
            font-style: normal;
            font-weight: 400;
            font-size: 8px;
            line-height: 22px;
          }
        }
      }

      .card-content {
        font-family: 'PingFang SC';
        font-style: normal;
        font-weight: 400;
        font-size: 14px;
        line-height: 22px;
        color: #2B2B2B;
        text-align: justify;
        
        pre {
          margin: 0;
          white-space: pre-wrap;
          word-wrap: break-word;
          font-family: 'PingFang SC';
          font-style: normal;
          font-weight: 400;
          font-size: 14px;
          line-height: 22px;
        }
      }

      .card-tags {
        display: flex;
        flex-direction: row;
        align-items: flex-start;
        padding: 6px 0;
        gap: 7px;
        flex-wrap: wrap;

        .tag {
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 0 5px;
          height: 22px;
          background: #E6E7FF;
          border-radius: 4px;
          font-family: 'Nunito Sans';
          font-style: normal;
          font-weight: 400;
          font-size: 14px;
          line-height: 22px;
          color: #605CE5;

          &.loading {
            background: #F2F3F5;
            color: #F2F3F5;
          }
        }
      }
    }
  }
}

@keyframes shimmer {
  100% {
    transform: translateX(100%);
  }
}

/* 卡片高亮样式 */
.assessment-card.highlighted {
  box-shadow: 0 0 0 2px #605CE5, 0 0 15px rgba(96, 92, 229, 0.5);
  transform: scale(1.02);
  transition: all 0.3s ease;
}
</style> 